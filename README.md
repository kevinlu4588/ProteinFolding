# Interpreting Protein Structure Prediction with ESMFold

---

[Project website](https://folding.baulab.info/) | [Paper on arXiv](https://arxiv.org/abs/2602.06020) | [Dataset on HuggingFace](https://huggingface.co/datasets/kevinlu4588/ProteinFolding/tree/main)

![Figure 1](Figure1.png)

## Repository Structure

```
.
├── demo_notebooks/      # Interactive Jupyter demos (patching, charge steering, distance steering)
├── src/                 # All experiment and analysis code (see src/README.md)
├── scripts/             # Data download/upload utilities
├── data/                # Datasets (downloaded from HuggingFace)
├── models/              # Pre-trained direction vectors and probes
├── results/             # Experiment outputs (generated by reproduce.sh)
├── environment.yml      # Conda environment specification
├── requirements.txt     # Python dependencies
└── reproduce.sh         # Script to reproduce all paper experiments
```

## 0. Set up the environment

Create the conda environment and install dependencies:

```bash
conda env create -f environment.yml
conda activate protein_folding
pip install -r requirements.txt
```

This installs Python 3.10, PyTorch (with CUDA), HuggingFace Transformers, BioPython, and DSSP, among other dependencies.

## 1. Demo Notebooks

The easiest way to get started is with the interactive demo notebooks in `demo_notebooks/`. These can be run immediately without downloading the full datasets:

| Notebook | Description |
|----------|-------------|
| `1_patching_notebook.ipynb` | Activation patching across ESMFold modules and individual trunk blocks |
| `2_charge_steering_notebook.ipynb` | Steering hairpin formation by injecting charge signals into sequence representations |
| `3_distance_steering_notebook.ipynb` | Steering hairpin formation using learned pairwise distance directions |

Each notebook loads ESMFold, runs a targeted intervention, and visualizes the resulting 3D structures side-by-side with baselines using py3Dmol.

## 2. Downloading datasets

To run the full experiments, download the datasets and pre-trained models from HuggingFace:

```bash
python scripts/download_from_hf.py
```

This populates `data/`, `models/`, and `results/` from the [HuggingFace repository](https://huggingface.co/datasets/kevinlu4588/ProteinFolding/tree/main). Use `--force` to overwrite existing files.

## 3. Reproducing experiments

All experiments from the paper can be reproduced using:

```bash
bash reproduce.sh
```

This runs 10 steps in sequence:

1. **Module patching** -- Patch all blocks of the ESM encoder, folding trunk, or structure module to identify which component is necessary and sufficient for hairpin formation.
2. **Module patching plots** -- Generate summary figures for module patching results.
3. **Block patching** -- Patch individual trunk blocks one at a time to identify the temporal dynamics of structural encoding.
4. **Representation tracking** -- Track how sequence and pairwise representations evolve through the trunk.
5. **Sliding window ablation** -- Ablate contiguous windows of trunk blocks to characterize the temporal resolution of structural decisions.
6. **Charge steering** -- Train difference-of-means charge directions, then steer hairpin formation by injecting complementary charge signals.
7. **Charge repulsion** -- Disrupt existing hairpins by injecting same-charge (repulsive) signals using directions from step 6.
8. **Contact steering** -- Train Ridge regression distance probes on pairwise representations, then use probe weights as steering directions.
9. **Bias analysis and patching** -- Analyze and control for positional biases in structure prediction.
10. **Z scaling and gradients** -- Scale pairwise (z) vs. sequence (s) representations independently and compute gradients to measure their relative importance.

Case counts for each step are configurable at the top of `reproduce.sh`. Individual steps can be commented out to run selectively.

For details on the source code organization, see [`src/README.md`](src/README.md).
